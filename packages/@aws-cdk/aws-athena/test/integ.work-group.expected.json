{
  "Resources": {
    "Bucket83908E77": {
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Retain",
      "DeletionPolicy": "Retain"
    },
    "WorkGroup26D4F855": {
      "Type": "AWS::Athena::WorkGroup",
      "Properties": {
        "Name": "workgroup",
        "RecursiveDeleteOption": true,
        "State": "ENABLED",
        "WorkGroupConfiguration": {
          "ResultConfiguration": {
            "OutputLocation": {
              "Fn::Join": [
                "",
                [
                  "s3://",
                  {
                    "Ref": "Bucket83908E77"
                  },
                  "/"
                ]
              ]
            }
          }
        }
      }
    },
    "WorkGroupDatabasehelloC4487E3A": {
      "Type": "Custom::AthenaDatabase",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "comamazonawscdkathenaqueryproviderQueryProviderframeworkonEventFD8415DC",
            "Arn"
          ]
        },
        "CreateQueryString": "CREATE DATABASE IF NOT EXISTS hello",
        "UpdateQueryString": "CREATE DATABASE IF NOT EXISTS hello",
        "DeleteQueryString": "DROP DATABASE IF EXISTS hello CASCADE",
        "WorkGroup": "workgroup"
      },
      "DependsOn": [
        "WorkGroup26D4F855"
      ],
      "UpdateReplacePolicy": "Delete",
      "DeletionPolicy": "Delete"
    },
    "WorkGroupDatabasehelloTableworldFC4F8CF6": {
      "Type": "Custom::AthenaTable",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "comamazonawscdkathenaqueryproviderQueryProviderframeworkonEventFD8415DC",
            "Arn"
          ]
        },
        "CreateQueryString": {
          "Fn::Join": [
            "",
            [
              "\n      CREATE EXTERNAL TABLE IF NOT EXISTS hello.world (ColumnA string,ColumnB int)\n      ROW FORMAT DELIMITED FIELDS TERMINATED BY ';'\n      STORED AS INPUTFORMAT 'org.apache.hadoop.mapred.TextInputFormat' OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'\n      LOCATION 's3://",
              {
                "Ref": "Bucket83908E77"
              },
              "/data/'\n      TBLPROPERTIES ('has_encrypted_data' = 'false')"
            ]
          ]
        },
        "UpdateQueryString": {
          "Fn::Join": [
            "",
            [
              "\n      CREATE EXTERNAL TABLE IF NOT EXISTS hello.world (ColumnA string,ColumnB int)\n      ROW FORMAT DELIMITED FIELDS TERMINATED BY ';'\n      STORED AS INPUTFORMAT 'org.apache.hadoop.mapred.TextInputFormat' OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'\n      LOCATION 's3://",
              {
                "Ref": "Bucket83908E77"
              },
              "/data/'\n      TBLPROPERTIES ('has_encrypted_data' = 'false')"
            ]
          ]
        },
        "DeleteQueryString": "DROP TABLE hello.world",
        "WorkGroup": "workgroup"
      },
      "UpdateReplacePolicy": "Delete",
      "DeletionPolicy": "Delete"
    },
    "comamazonawscdkathenaqueryproviderQueryLambdaServiceRole262E0E7E": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition"
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
              ]
            ]
          }
        ]
      }
    },
    "comamazonawscdkathenaqueryproviderQueryLambdaServiceRoleDefaultPolicyC13A0865": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "athena:*",
              "Effect": "Allow",
              "Resource": "*"
            },
            {
              "Action": "s3:*",
              "Effect": "Allow",
              "Resource": "*"
            },
            {
              "Action": "glue:*",
              "Effect": "Allow",
              "Resource": "*"
            }
          ],
          "Version": "2012-10-17"
        },
        "PolicyName": "comamazonawscdkathenaqueryproviderQueryLambdaServiceRoleDefaultPolicyC13A0865",
        "Roles": [
          {
            "Ref": "comamazonawscdkathenaqueryproviderQueryLambdaServiceRole262E0E7E"
          }
        ]
      }
    },
    "comamazonawscdkathenaqueryproviderQueryLambda8E70D79F": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "\nimport logging\nimport cfnresponse\nimport botocore.session\nimport time\n\nlogger = logging.getLogger()\nlogger.setLevel(logging.INFO)\n\nsession = botocore.session.get_session()\nclient = session.create_client('athena')\n\ndef on_event(event, context):\n    try:\n        physical_id = 'AthenaQuery' + event['RequestId']\n        request_type = event['RequestType']\n\n        queryString = ''\n        if request_type == 'Create':\n            queryString = event['ResourceProperties']['CreateQueryString']\n        elif request_type == 'Update':\n            queryString = event['ResourceProperties']['UpdateQueryString']\n        elif request_type == 'Delete':\n            queryString = event['ResourceProperties']['DeleteQueryString']\n\n        print(queryString)\n\n        workGroup = event['ResourceProperties']['WorkGroup']\n\n        query = client.start_query_execution(\n            QueryString=queryString,\n            WorkGroup=workGroup\n        )\n\n        query_id = query['QueryExecutionId']\n\n        sleep_amount = 2\n        max_attempts = 20\n        num_attempts = 0\n        execution_state = 'RUNNING'\n\n        while execution_state == 'RUNNING' or execution_state == 'QUEUED':\n          execution = client.get_query_execution(QueryExecutionId=query_id)\n          num_attempts += 1\n\n          execution_state = execution['QueryExecution']['Status']['State']\n          if execution_state == 'SUCCEEDED':\n            print('Query succeeded')\n            cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physical_id)\n            break\n          elif execution_state == 'CANCELLED' or execution_state == 'FAILED' or num_attempts >= max_attempts:\n            print('Query failed or cancelled: ' + execution['QueryExecution']['Status']['StateChangeReason'])\n            cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physical_id)\n            break\n\n          time.sleep(sleep_amount)\n\n    except Exception as e:\n        logger.exception(e)\n        cfnresponse.send(event, context, cfnresponse.FAILED, {}, physical_id)\n"
        },
        "Handler": "index.on_event",
        "Role": {
          "Fn::GetAtt": [
            "comamazonawscdkathenaqueryproviderQueryLambdaServiceRole262E0E7E",
            "Arn"
          ]
        },
        "Runtime": "python3.7"
      },
      "DependsOn": [
        "comamazonawscdkathenaqueryproviderQueryLambdaServiceRoleDefaultPolicyC13A0865",
        "comamazonawscdkathenaqueryproviderQueryLambdaServiceRole262E0E7E"
      ]
    },
    "comamazonawscdkathenaqueryproviderQueryProviderframeworkonEventServiceRole93461E89": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition"
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
              ]
            ]
          }
        ]
      }
    },
    "comamazonawscdkathenaqueryproviderQueryProviderframeworkonEventServiceRoleDefaultPolicyEE7D3F24": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "lambda:InvokeFunction",
              "Effect": "Allow",
              "Resource": {
                "Fn::GetAtt": [
                  "comamazonawscdkathenaqueryproviderQueryLambda8E70D79F",
                  "Arn"
                ]
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "PolicyName": "comamazonawscdkathenaqueryproviderQueryProviderframeworkonEventServiceRoleDefaultPolicyEE7D3F24",
        "Roles": [
          {
            "Ref": "comamazonawscdkathenaqueryproviderQueryProviderframeworkonEventServiceRole93461E89"
          }
        ]
      }
    },
    "comamazonawscdkathenaqueryproviderQueryProviderframeworkonEventFD8415DC": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Ref": "AssetParameters082715a6f74a051218c287c9750d2fff07912878d011fad47eb21f33f335a33aS3Bucket347EC9ED"
          },
          "S3Key": {
            "Fn::Join": [
              "",
              [
                {
                  "Fn::Select": [
                    0,
                    {
                      "Fn::Split": [
                        "||",
                        {
                          "Ref": "AssetParameters082715a6f74a051218c287c9750d2fff07912878d011fad47eb21f33f335a33aS3VersionKeyDE3A9B7E"
                        }
                      ]
                    }
                  ]
                },
                {
                  "Fn::Select": [
                    1,
                    {
                      "Fn::Split": [
                        "||",
                        {
                          "Ref": "AssetParameters082715a6f74a051218c287c9750d2fff07912878d011fad47eb21f33f335a33aS3VersionKeyDE3A9B7E"
                        }
                      ]
                    }
                  ]
                }
              ]
            ]
          }
        },
        "Handler": "framework.onEvent",
        "Role": {
          "Fn::GetAtt": [
            "comamazonawscdkathenaqueryproviderQueryProviderframeworkonEventServiceRole93461E89",
            "Arn"
          ]
        },
        "Runtime": "nodejs10.x",
        "Environment": {
          "Variables": {
            "USER_ON_EVENT_FUNCTION_ARN": {
              "Fn::GetAtt": [
                "comamazonawscdkathenaqueryproviderQueryLambda8E70D79F",
                "Arn"
              ]
            }
          }
        },
        "Timeout": 900
      },
      "DependsOn": [
        "comamazonawscdkathenaqueryproviderQueryProviderframeworkonEventServiceRoleDefaultPolicyEE7D3F24",
        "comamazonawscdkathenaqueryproviderQueryProviderframeworkonEventServiceRole93461E89"
      ]
    }
  },
  "Parameters": {
    "AssetParameters082715a6f74a051218c287c9750d2fff07912878d011fad47eb21f33f335a33aS3Bucket347EC9ED": {
      "Type": "String",
      "Description": "S3 bucket for asset \"082715a6f74a051218c287c9750d2fff07912878d011fad47eb21f33f335a33a\""
    },
    "AssetParameters082715a6f74a051218c287c9750d2fff07912878d011fad47eb21f33f335a33aS3VersionKeyDE3A9B7E": {
      "Type": "String",
      "Description": "S3 key for asset version \"082715a6f74a051218c287c9750d2fff07912878d011fad47eb21f33f335a33a\""
    },
    "AssetParameters082715a6f74a051218c287c9750d2fff07912878d011fad47eb21f33f335a33aArtifactHash0DA92241": {
      "Type": "String",
      "Description": "Artifact hash for asset \"082715a6f74a051218c287c9750d2fff07912878d011fad47eb21f33f335a33a\""
    }
  }
}